<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="productns">
	<!-- join resultMap -->
	<resultMap type="room" id="roomResult">
	    <result column="rm_no" property="rm_no"/>
	    <result column="rm_pno" property="rm_pno"/>
	    <result column="rm_rno" property="rm_rno"/>
	</resultMap>
	
	<resultMap type="product" id="productResult">
	    <result column="pro_no" property="pro_no"/>
	    <result column="sel_id" property="sel_id"/>
	    <result column="pro_ceo" property="pro_ceo"/>
	    <result column="pro_name" property="pro_name"/>
	    <result column="pro_post" property="pro_post"/>
	    <result column="pro_addr" property="pro_addr"/>
	    <result column="pro_n1" property="pro_n1"/>
	    <result column="pro_n2" property="pro_n2"/>
	    <result column="pro_x" property="pro_x"/>
	    <result column="pro_y" property="pro_y"/>
	    <result column="pro_con" property="pro_con"/>
	    <result column="pro_pic" property="pro_pic"/>
	    <result column="pro_intro" property="pro_intro"/>
	    <result column="pro_app" property="pro_app"/>
	    <result column="pro_con" property="pro_con"/>
	    <result column="pro_joind" property="pro_joind"/>
	    <result column="pro_s" property="pro_s"/>
	    <collection property="roomR" resultMap="roomResult"/>
	</resultMap>
	<!-- 검색 및 목록 페이지 -->
	<!-- 1. 데이터 검색(조건: 지역, 인원수) -->
	<select id="list" parameterType="product" resultMap="productResult">
		select * from (select a.*,rowNum rn from (
			<if test="cap > 0 and cap != null">
				select p.*, r.rm_no ,r.rm_rno, r.rm_pno from product p join room r on p.pro_no = r.pro_no 
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
				and <![CDATA[rm_rno >= #{cap, jdbcType=INTEGER}]]>
			</if>
			<if test="cap == 0 and checkIn != null and checkOut != null">
				select p.*, r.rm_no ,r.rm_rno, r.rm_pno from product p join room r on p.pro_no = r.pro_no 
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
			</if>
			<if test="cap == 0 and checkIn == null and checkOut == null">
					select * from product
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
			</if>
			 order by pro_joind desc) a )
			 where rn between #{startRow, jdbcType=INTEGER} and #{endRow, jdbcType=INTEGER}
	</select>
	
	<!-- 2. 총 데이터 개수 -->
	<select id="gettotal" parameterType="product" resultType="int">
		select count(*) from ( 
			<if test="cap > 0 and cap != null">
				select p.*, r.rm_no ,r.rm_rno, r.rm_pno from product p join room r on p.pro_no = r.pro_no 
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
				and <![CDATA[rm_rno >= #{cap, jdbcType=INTEGER}]]>
			</if>
			<if test="cap == 0 and checkIn != null and checkOut != null">
				select p.*, r.rm_no ,r.rm_rno, r.rm_pno from product p join room r on p.pro_no = r.pro_no 
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
			</if>
			<if test="cap == 0 and checkIn == null and checkOut == null">
					select * from product
				<where>
					<if test="keyword != null and region=='all'">
						pro_name like '%'||#{keyword}||'%' or
						pro_addr like '%'||#{keyword}||'%'
					</if>
					<if test="keyword != null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%' and
						pro_addr like '%'||#{keyword}||'%' or
						pro_name like '%'||#{keyword}||'%'
					</if>
					<if test="keyword == null and region!='all' and region != null">
						pro_addr like '%'||#{region}||'%'
					</if>
				</where>
			</if>
			)
	</select>
	
	<!-- 2.  -->
	<!-- <select id="list" parameterType="product" resultType="product">
		select * from (select a.*,rowNum rn from (
			select * from product
		<where>
			<if test="keyword != null and region=='all'">
				pro_name like '%'||#{keyword}||'%' or
				pro_addr like '%'||#{keyword}||'%'
			</if>
			<if test="keyword != null and region!='all'">
				pro_addr like '%'||#{keyword}||'%' and
				pro_addr like '%'||#{keyword}||'%' or
				pro_name like '%'||#{keyword}||'%'
			</if>
		</where>			
			 order by pro_joind desc) a )
			where rn between #{startRow} and #{endRow} 
	</select> -->
	
	<!-- 메인 페이지 -->
	<!-- 1. 하단 일반 데이터 -->
	<select id="listtop" parameterType="product" resultType="product">
		select * from (select * from product order by pro_joind desc) where <![CDATA[rownum <=5]]>
	</select>
	
	<!-- 2. 추천 목록 데이터 -->
	<select id="listbest" parameterType="product" resultType="product">
		select * from product where pro_s = 3 order by pro_joind desc
	</select>
	
	
	<!-- 상세 페이지 -->
	<!-- 5. 1개 데이터  -->
	<select id="select" parameterType="int" resultType="product">
		select * from product where pro_no = #{pro_no}
	</select>
</mapper>